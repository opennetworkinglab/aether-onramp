# SPDX-FileCopyrightText: 2026 The Linux Foundation
# SPDX-License-Identifier: Apache-2.0

# GitHub Actions workflow replicating srsran.groovy functionality

name: Aether OnRamp srsRAN

on:
  workflow_dispatch:
    inputs:
      agent_label:
        description: "Label for selecting runner (if using self-hosted)"
        required: false
        default: "ubuntu-latest"
        type: string

jobs:
  quickstart-srsran:
    runs-on: ${{ github.event.inputs.agent_label || 'ubuntu-latest' }}
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Create Python virtual environment
        run: |
          python -m venv $HOME/ubuntu_venv
          source $HOME/ubuntu_venv/bin/activate
          pip install --upgrade pip
          pip install ansible requests

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.17.1"

      - name: Configure OnRamp
        run: |
          source $HOME/ubuntu_venv/bin/activate

          # Get network information
          MYIP=$(hostname -I | awk '{print $1}')
          echo "MY IP is: $MYIP"
          MYIFC=$(ip route get 8.8.8.8 | awk '/dev/ {print $5; exit}' || echo "eth0")
          echo "MY IFC is: $MYIFC"
          MYIPNET=$(ip addr show $MYIFC | grep 'inet ' | awk '{print $2}')
          echo "MY IPNET is: $MYIPNET"

          # Create hosts.ini for local execution (no SSH needed on GitHub runner)
          cat > hosts.ini << EOF
          [all]
          localhost ansible_connection=local ansible_user=$USER ansible_python_interpreter=/usr/bin/python3

          [master_nodes]
          localhost

          [worker_nodes]
          #node2

          [srsran_nodes]
          localhost
          EOF

          # Configure vars/main.yml
          VARS_MAIN="vars/main.yml"
          cp vars/main-srsran.yml "$VARS_MAIN"
          sed -i "s|ens18|$MYIFC|g" "$VARS_MAIN"
          sed -i "s|10.76.28.113|$MYIP|" "$VARS_MAIN"
          sed -i 's|172.20.0.0/16|""|' "$VARS_MAIN"
          sed -i "s|10.76.28.115|$MYIP|" "$VARS_MAIN"
          sed -i "s|10.76.28.0/24|$MYIPNET|" "$VARS_MAIN"
          git diff "$VARS_MAIN"

          # Verify configuration
          make aether-pingall

      - name: Install Aether
        # TODO: Remove the sed from below script once the change is merged to
        # the dep repo
        run: |
          source $HOME/ubuntu_venv/bin/activate
          sed -i '97a\
              sleep 30
          ' $GITHUB_WORKSPACE/deps/k8s/roles/rke2/tasks/install.yml
          make aether-k8s-install
          make aether-5gc-install
          sleep 10
          make aether-srsran-gnb-install
          kubectl get pods -n aether-5gc
          docker ps
          sleep 10

      - name: Run srs-uesim
        continue-on-error: true
        run: |
          source $HOME/ubuntu_venv/bin/activate
          make aether-srsran-uesim-start

      - name: Validate Results
        continue-on-error: false
        run: |
          source $HOME/ubuntu_venv/bin/activate
          docker exec rfsim5g-srsran-nr-ue ip netns exec ue1 ping -c 5 192.168.250.1 > srs-uesim.log
          grep "0% packet loss" srs-uesim.log

      - name: Retrieve Logs
        if: always()
        run: |
          source $HOME/ubuntu_venv/bin/activate
          mkdir -p logs
          cd logs

          # Get srsRAN gNB logs
          docker logs srsran-gnb > srsran_gnb.log 2>&1 || echo "Failed to get srsran-gnb logs"

          # Get srsRAN UE logs
          docker logs rfsim5g-srsran-nr-ue > srsran_ue.log 2>&1 || echo "Failed to get srsran-nr-ue logs"

          # Get AMF logs
          AMF_POD_NAME=$(kubectl get pods -n aether-5gc | grep amf | awk 'NR==1{print $1}' || echo "")
          if [ -n "$AMF_POD_NAME" ]; then
            echo "Retrieving AMF logs from: ${AMF_POD_NAME}"
            kubectl logs $AMF_POD_NAME -n aether-5gc > srsran_amf.log
          fi

          # Get WebUI logs
          WEBUI_POD_NAME=$(kubectl get pods -n aether-5gc | grep webui | awk 'NR==1{print $1}' || echo "")
          if [ -n "$WEBUI_POD_NAME" ]; then
            echo "Retrieving WebUI logs from: ${WEBUI_POD_NAME}"
            kubectl logs $WEBUI_POD_NAME -n aether-5gc > srsran_webui.log
          fi

          # Get UDR logs
          UDR_POD_NAME=$(kubectl get pods -n aether-5gc | grep udr | awk 'NR==1{print $1}' || echo "")
          if [ -n "$UDR_POD_NAME" ]; then
            echo "Retrieving UDR logs from: ${UDR_POD_NAME}"
            kubectl logs $UDR_POD_NAME -n aether-5gc > srsran_udr.log
          fi

          # Get UDM logs
          UDM_POD_NAME=$(kubectl get pods -n aether-5gc | grep udm | awk 'NR==1{print $1}' || echo "")
          if [ -n "$UDM_POD_NAME" ]; then
            echo "Retrieving UDM logs from: ${UDM_POD_NAME}"
            kubectl logs $UDM_POD_NAME -n aether-5gc > srsran_udm.log
          fi

          # Get AUSF logs
          AUSF_POD_NAME=$(kubectl get pods -n aether-5gc | grep ausf | awk 'NR==1{print $1}' || echo "")
          if [ -n "$AUSF_POD_NAME" ]; then
            echo "Retrieving AUSF logs from: ${AUSF_POD_NAME}"
            kubectl logs $AUSF_POD_NAME -n aether-5gc > srsran_ausf.log
          fi

          # Get SMF logs
          SMF_POD_NAME=$(kubectl get pods -n aether-5gc | grep smf | awk 'NR==1{print $1}' || echo "")
          if [ -n "$SMF_POD_NAME" ]; then
            echo "Retrieving SMF logs from: ${SMF_POD_NAME}"
            kubectl logs $SMF_POD_NAME -n aether-5gc > srsran_smf.log
          fi

      - name: Archive Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: srsran-logs
          path: logs/*.log
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: |
          if [ -f $HOME/ubuntu_venv/bin/activate ]; then
            source $HOME/ubuntu_venv/bin/activate
          fi
          make aether-srsran-uesim-stop || echo "Failed to stop srsran uesim"
          make aether-srsran-gnb-uninstall || echo "Failed to uninstall srsran gnb"
          make aether-5gc-uninstall || echo "Failed to uninstall 5gc"
          make aether-k8s-uninstall || echo "Failed to uninstall k8s"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Workflow failed: ${{ github.repository }} - ${{ github.run_number }} - ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add Slack notification here if needed using secrets.SLACK_WEBHOOK_URL
